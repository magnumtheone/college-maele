{% load static %}
<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Collège Maele — Articles</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{--cm-blue:#1e3a8a;--cm-blue2:#2563eb}
    body{font-family:'Inter',sans-serif;background:#f7fafc;color:#1a202c}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.04)}
    .chip{display:inline-flex;align-items:center;gap:.4rem;border:1px solid rgba(30,58,138,.18);color:#1e3a8a;background:#fff;border-radius:9999px;padding:.35rem .7rem;font-size:.75rem;font-weight:600}
    .chip.active{background:var(--cm-blue);color:#fff;border-color:var(--cm-blue)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.8rem;font-weight:700;transition:transform .15s,box-shadow .15s,background .15s,color .15s}
    .btn-primary{background-image:linear-gradient(90deg,var(--cm-blue2),var(--cm-blue));color:#fff;box-shadow:0 10px 15px -3px rgb(37 99 235 /.25)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 20px 25px -5px rgb(30 58 138 /.25)}
    .btn-outline{background:#fff;color:var(--cm-blue);border:1px solid rgba(30,64,175,.25)}
    .btn-outline:hover{background:#eff6ff}
    .skeleton{position:relative;overflow:hidden;background:#eef2ff;border-radius:.8rem}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
    /* Progress bar styling */
    .progress-wrap { position: fixed; left: 0; right: 0; top: 0; height: 4px; z-index: 60; pointer-events: none; }
    .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg,#2563eb,#1e40af); transform-origin: 0 50%; transition: width .12s linear; }
  </style>
</head>
<body>
  <div class="progress-wrap" aria-hidden="true"><div id="progressBar" class="progress-bar"></div></div>
  <!-- HEADER -->
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4 flex items-center justify-between">
      <a href="{% url 'home' %}#blog" class="flex items-center gap-3 text-gray-900">
        <i class="fa-solid fa-graduation-cap text-blue-600 text-2xl"></i>
        <span class="font-bold text-lg">Collège Maele</span>
      </a>
      <nav class="hidden md:flex gap-6 text-gray-600">
        <a href="{% url 'home' %}#blog" class="hover:text-blue-600">Retour</a>
        <a href="{% url 'home' %}#contact" class="hover:text-blue-600">Contact</a>
      </nav>
      <button class="md:hidden text-gray-700" aria-label="Ouvrir le menu mobile"><i class="fas fa-bars"></i></button>
    </div>
  </header>

  <main class="container mx-auto px-6 py-10">
    <!-- HERO -->
    <header class="text-center mb-10">
      <div class="inline-flex items-center gap-2 chip">
        <i class="fa-regular fa-newspaper"></i> Actualités
      </div>
      <h1 class="text-3xl md:text-4xl font-extrabold text-blue-900 mt-2">Derniers Articles</h1>
      <p class="text-gray-600 mt-2 max-w-2xl mx-auto">Actualités, événements et publications du Collège Maele.</p>
    </header>

    <!-- BARRE D’OUTILS -->
    <section class="card p-4 md:p-6 mb-8" aria-label="Filtres et recherche des articles">
      <div class="grid md:grid-cols-5 gap-4">
        <!-- Recherche -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Rechercher</label>
          <div class="relative">
            <input id="searchInput" type="text" placeholder="Titre, extrait, tag, auteur…"
              class="w-full rounded-xl border border-gray-300/80 bg-white px-4 py-3 pr-10 shadow-sm placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30">
            <i class="fa-solid fa-magnifying-glass absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
        <!-- Auteur -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Auteur</label>
          <select id="authorSelect" class="w-full rounded-xl border border-gray-300/80 bg-white px-4 py-3 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30">
            <option value="">Tous</option>
          </select>
        </div>
        <!-- Année -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Année</label>
          <select id="yearSelect" class="w-full rounded-xl border border-gray-300/80 bg-white px-4 py-3 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30">
            <option value="">Toutes</option>
          </select>
        </div>
        <!-- Tri -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Trier par</label>
          <select id="sortSelect" class="w-full rounded-xl border border-gray-300/80 bg-white px-4 py-3 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/30">
            <option value="date_desc">Plus récent</option>
            <option value="date_asc">Plus ancien</option>
            <option value="title_asc">Titre (A → Z)</option>
            <option value="title_desc">Titre (Z → A)</option>
            <option value="author_asc">Auteur (A → Z)</option>
            <option value="author_desc">Auteur (Z → A)</option>
          </select>
        </div>
      </div>

      <!-- Tags -->
      <div class="mt-4">
        <p class="text-sm font-medium text-gray-700 mb-2">Tags</p>
        <div id="chipsRow" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Résumé -->
      <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
        <span id="resultCount">—</span>
        <div class="flex items-center gap-2">
          <button id="resetBtn" class="btn btn-outline px-4 py-2"><i class="fa-solid fa-rotate-left mr-2"></i>Réinitialiser</button>
          <button id="viewToggle" class="btn btn-outline px-3 py-2" title="Basculer grille/liste"><i class="fa-solid fa-table-cells-large"></i></button>
        </div>
      </div>
    </section>

    <!-- GRID/LIST -->
    <section id="articlesWrap" class="card p-4 md:p-6">
      <div id="articlesGrid" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% for article in articles %}
        <article class="article-card bg-white rounded-xl border overflow-hidden shadow hover:shadow-lg transition group"
                 data-title="{{ article.titre }}"
                 data-author="{{ article.auteur }}"
                 data-date="{{ article.date_publication|date:'Y-m-d' }}"
                 data-tags="{% if article.tags %}{% if article.tags.all %}{% for t in article.tags.all %}{{ t.name }}{% if not forloop.last %},{% endif %}{% endfor %}{% else %}{{ article.tags }}{% endif %}{% endif %}">
          <a href="{% url 'detail_article' id_article=article.id %}" class="block focus:outline-none">
            {% if article.image %}
            <div class="relative overflow-hidden">
              <img loading="lazy" src="{{ article.image.url }}" alt="{{ article.titre }}" class="w-full h-44 object-cover transition-transform duration-300 group-hover:scale-105">
              {% if article.categorie %}<span class="absolute left-3 top-3 chip bg-white/90 backdrop-blur border border-white/60">{{ article.categorie }}</span>{% endif %}
            </div>
            {% else %}
            <img loading="lazy" src="{% static 'blog/Images/default-article.jpg' %}" alt="{{ article.titre }}" class="w-full h-44 object-cover">
            {% endif %}
            <div class="p-5">
              <h2 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{{ article.titre }}</h2>
              <div class="text-sm text-gray-500 mb-3 flex items-center flex-wrap gap-x-4 gap-y-1">
                <span class="flex items-center"><i class="fas fa-calendar-alt mr-1"></i>{{ article.date_publication|date:"d F Y" }}</span>
                <span class="flex items-center"><i class="fas fa-user-circle mr-1"></i>{{ article.auteur }}</span>
              </div>
              <p class="text-gray-700 text-sm mb-4 line-clamp-3">{{ article.contenu|truncatewords:32 }}</p>
              <div class="flex items-center justify-between">
                <span class="text-blue-600 font-semibold group-hover:underline">Lire la suite <i class="fas fa-arrow-right ml-2"></i></span>
                <span class="text-xs text-gray-400">{{ article.date_publication|timesince }} auparavant</span>
              </div>
              {% if article.tags %}
              <div class="mt-3 flex flex-wrap gap-2">
                {% if article.tags.all %}
                  {% for t in article.tags.all %}<span class="chip text-[11px]">{{ t.name }}</span>{% endfor %}
                {% else %}
                  {% with tags=article.tags|stringformat:"s"|cut:"["|cut:"]"|cut:"'"|cut:'"'|cut:" " %}
                    {% for t in tags|split:"," %}
                      {% with tag=t|stringformat:"s"|cut:"'" %}
                        <span class="chip text-[11px]">{{ tag }}</span>
                      {% endwith %}
                    {% endfor %}
                  {% endwith %}
                {% endif %}
              </div>
              {% endif %}
            </div>
          </a>
        </article>
        {% empty %}
          {% for i in "123456" %}
          <div class="skeleton h-72"></div>
          {% endfor %}
        {% endfor %}
      </div>

      <!-- ÉTAT VIDE -->
      <div id="emptyState" class="hidden text-center py-12">
        <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-blue-50 text-blue-700">
          <i class="fa-regular fa-newspaper"></i>
        </div>
        <p class="mt-3 font-semibold text-blue-900">Aucun article ne correspond à vos filtres</p>
        <p class="text-sm text-gray-600">Essayez d’enlever un tag, de changer d’année, ou de vider la recherche.</p>
        <div class="mt-4">
          <button id="clearFilters2" class="btn btn-outline px-4 py-2"><i class="fa-solid fa-broom mr-2"></i>Effacer les filtres</button>
        </div>
      </div>

      <!-- PAGINATION CLIENT -->
      <div id="loadMoreWrap" class="text-center mt-8">
        <button id="loadMoreBtn" class="btn btn-primary px-5 py-3"><i class="fa-solid fa-plus mr-2"></i>Afficher plus</button>
      </div>
    </section>

    <!-- Lien retour -->
    <div class="mt-8 text-center">
      <a href="{% url 'home' %}#blog" class="inline-block btn btn-outline px-5 py-3">
        Voir la section Blog sur la page d’accueil
      </a>
    </div>
  </main>

  <footer class="bg-gray-900 text-white mt-12">
    <div class="container mx-auto px-6 py-8 flex flex-col md:flex-row justify-between items-center">
      <div>
        <h4 class="font-bold text-lg">Collège Maele</h4>
        <p class="text-gray-400 text-sm">© <span id="current-year"></span> Tous droits réservés.</p>
      </div>
      <div class="flex gap-4 mt-4 md:mt-0">
        <a href="https://wa.me/243812345678" target="_blank" rel="noopener" class="text-green-400 hover:text-white text-2xl"><i class="fab fa-whatsapp"></i></a>
        <a href="https://facebook.com/collegemaele" target="_blank" rel="noopener" class="text-blue-600 hover:text-white text-2xl"><i class="fab fa-facebook-f"></i></a>
        <a href="https://instagram.com/collegemaele" target="_blank" rel="noopener" class="text-pink-500 hover:text-white text-2xl"><i class="fab fa-instagram"></i></a>
        <a href="https://www.linkedin.com/company/collegemaele" target="_blank" rel="noopener" class="text-sky-500 hover:text-white text-2xl"><i class="fab fa-linkedin-in"></i></a>
      </div>
    </div>
  </footer>

  <script>
  // Année footer
  document.getElementById('current-year').textContent = new Date().getFullYear();

  document.addEventListener('DOMContentLoaded', () => {
    const cards = Array.from(document.querySelectorAll('.article-card'));
    const grid  = document.getElementById('articlesGrid');

    const searchInput = document.getElementById('searchInput');
    const authorSelect = document.getElementById('authorSelect');
    const yearSelect   = document.getElementById('yearSelect');
    const sortSelect   = document.getElementById('sortSelect');
    const chipsRow     = document.getElementById('chipsRow');
    const resultCount  = document.getElementById('resultCount');
    const resetBtn     = document.getElementById('resetBtn');
    const clearFilters2= document.getElementById('clearFilters2');
    const emptyState   = document.getElementById('emptyState');
    const loadMoreBtn  = document.getElementById('loadMoreBtn');
    const loadMoreWrap = document.getElementById('loadMoreWrap');
    const viewToggle   = document.getElementById('viewToggle');

    // Grille/Liste toggle
    let listMode = false;
    viewToggle.addEventListener('click', ()=>{
      listMode = !listMode;
      viewToggle.innerHTML = listMode ? '<i class="fa-solid fa-list"></i>' : '<i class="fa-solid fa-table-cells-large"></i>';
      grid.className = listMode ? 'grid gap-6 md:grid-cols-1' : 'grid gap-6 md:grid-cols-2 lg:grid-cols-3';
    });

    // Construire auteurs / années / tags
    const tagSet = new Set(); const authorSet = new Set(); const yearSet = new Set();
    const yyyy = d => (d||'').slice(0,4);

    cards.forEach(c=>{
      const a = (c.dataset.author||'').trim(); if(a) authorSet.add(a);
      const y = yyyy(c.dataset.date||''); if(y) yearSet.add(y);
      const ts = (c.dataset.tags||'').split(',').map(t=>t.trim()).filter(Boolean);
      ts.forEach(t => tagSet.add(t));
    });

    authorSelect.innerHTML = '<option value="">Tous</option>' + Array.from(authorSet).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})).map(a=>`<option value="${a}">${a}</option>`).join('');
    yearSelect.innerHTML = '<option value="">Toutes</option>' + Array.from(yearSet).sort((a,b)=>b.localeCompare(a)).map(y=>`<option value="${y}">${y}</option>`).join('');

    let activeTags = new Set();
    function renderChips(){
      chipsRow.innerHTML = '';
      Array.from(tagSet).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})).forEach(tag=>{
        const b = document.createElement('button');
        b.type='button'; b.className='chip '+(activeTags.has(tag)?'active':''); b.innerHTML='<i class="fa-solid fa-tag text-xs"></i> '+tag;
        b.addEventListener('click', ()=>{ activeTags.has(tag)?activeTags.delete(tag):activeTags.add(tag); filterSortRender(true); renderChips(); });
        chipsRow.appendChild(b);
      });
      if(activeTags.size){
        const clr=document.createElement('button'); clr.type='button'; clr.className='chip'; clr.innerHTML='<i class="fa-solid fa-xmark text-xs"></i> Effacer tags';
        clr.addEventListener('click', ()=>{ activeTags.clear(); filterSortRender(true); renderChips(); });
        chipsRow.appendChild(clr);
      }
    }
    renderChips();

    // Filtrage / Tri
    function matches(c,q,author,year,tags){
      const t = (c.dataset.title||'').toLowerCase();
      const a = (c.dataset.author||'').toLowerCase();
      const tg= (c.dataset.tags||'').toLowerCase();
      const hay = t+' '+a+' '+tg+' '+(c.textContent||'').toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(author && (c.dataset.author||'')!==author) return false;
      if(year && yyyy(c.dataset.date||'')!==year) return false;
      if(tags && tags.size){
        const have = new Set((c.dataset.tags||'').split(',').map(x=>x.trim().toLowerCase()));
        for(const tag of tags){ if(!have.has(tag.toLowerCase())) return false; }
      }
      return true;
    }
    function sortCards(list,mode){
      const g = s => (s||'').toLowerCase();
      switch(mode){
        case 'date_asc':  return list.sort((A,B)=> (A.dataset.date||'').localeCompare(B.dataset.date||''));
        case 'title_asc': return list.sort((A,B)=> g(A.dataset.title).localeCompare(g(B.dataset.title),'fr',{sensitivity:'base'}));
        case 'title_desc':return list.sort((A,B)=> g(B.dataset.title).localeCompare(g(A.dataset.title),'fr',{sensitivity:'base'}));
        case 'author_asc':return list.sort((A,B)=> g(A.dataset.author).localeCompare(g(B.dataset.author),'fr',{sensitivity:'base'}));
        case 'author_desc':return list.sort((A,B)=> g(B.dataset.author).localeCompare(g(A.dataset.author),'fr',{sensitivity:'base'}));
        case 'date_desc':
        default: return list.sort((A,B)=> (B.dataset.date||'').localeCompare(A.dataset.date||''));
      }
    }

    // “Afficher plus” (client)
    const PAGE_SIZE = 9;
    let visibleRefs = []; let shown = 0;

    function renderList(withSkeleton=false){
      const overlay = withSkeleton ? addSkeleton() : null;
      grid.innerHTML = '';
      const slice = visibleRefs.slice(0, shown);
      slice.forEach(c => grid.appendChild(c));
      loadMoreWrap.classList.toggle('hidden', shown >= visibleRefs.length || visibleRefs.length===0);
      emptyState.classList.toggle('hidden', visibleRefs.length>0);
      resultCount.textContent = `${visibleRefs.length} article${visibleRefs.length>1?'s':''}`;
      if(overlay) setTimeout(()=> overlay.remove(), 200);
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
    function addSkeleton(){
      const overlay = document.createElement('div');
      overlay.className='grid gap-6 md:grid-cols-2 lg:grid-cols-3';
      overlay.innerHTML = Array(6).fill(0).map(()=>'<div class="skeleton h-72"></div>').join('');
      grid.parentElement.appendChild(overlay);
      return overlay;
    }

    function filterSortRender(withSkeleton=false){
      const q = (searchInput.value||'').trim().toLowerCase();
      const author = authorSelect.value;
      const year   = yearSelect.value;

      // Filtrer
      const filtered = cards.filter(c => matches(c,q,author,year,activeTags));
      // Trier
      sortCards(filtered, sortSelect.value);
      // Reset pagination
      visibleRefs = filtered;
      shown = Math.min(PAGE_SIZE, visibleRefs.length);
      renderList(withSkeleton);
    }

    // Interactions
    let t=null;
    searchInput.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=>filterSortRender(true), 180); });
    authorSelect.addEventListener('change', ()=>filterSortRender(true));
    yearSelect.addEventListener('change', ()=>filterSortRender());
    sortSelect.addEventListener('change', ()=>filterSortRender());
    resetBtn.addEventListener('click', ()=>{
      searchInput.value=""; authorSelect.value=""; yearSelect.value=""; sortSelect.value="date_desc"; activeTags.clear(); renderChips(); filterSortRender(true);
    });
    clearFilters2?.addEventListener('click', ()=> resetBtn.click());
    loadMoreBtn.addEventListener('click', ()=>{
      shown = Math.min(shown + PAGE_SIZE, visibleRefs.length);
      renderList();
    });

    // Init
    filterSortRender();
  });
  </script>
  <script>
    (function(){
      const bar = document.getElementById('progressBar');
      if(!bar) return;
      function update(){
        const doc = document.documentElement;
        const scrollTop = window.scrollY || doc.scrollTop || 0;
        const height = doc.scrollHeight - doc.clientHeight;
        const pct = height > 0 ? Math.min(100, Math.max(0, (scrollTop / height) * 100)) : 0;
        bar.style.width = pct + '%';
      }
      window.addEventListener('scroll', update, { passive: true });
      window.addEventListener('resize', update);
      update();
    })();
  </script>
</body>
</html>
